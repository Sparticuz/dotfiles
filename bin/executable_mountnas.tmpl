#!/bin/bash
set -euo pipefail

# Check if sshfs is installed
if ! command -v sshfs &> /dev/null; then
  echo "Error: sshfs is not installed. Please install it first."
  exit 1
fi

# Function to check if a directory is mounted
is_mounted() {
  mount | grep -q "on $1 type"
}

# Securely create a directory if it doesn't exist
create_dir_if_not_exists() {
  local dir="$1"
  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
    echo "Created directory: $dir"
  fi
}

# Mount a directory using sshfs
mount_sshfs() {
  local remote_path="$1"
  local local_path="$2"
  local port="$3"
  local username="$4"
  local host="$5"

  if is_mounted "$local_path"; then
    echo "$local_path is already mounted"
  else
    sshfs -o IdentityFile=~/.ssh/id_haven,idmap=user,compression=yes,follow_symlinks,allow_other,default_permissions,port="$port" \
      "$username@$host:$remote_path" "$local_path"
    echo "Mounted $remote_path to $local_path"
  fi
}

# Load sensitive data from environment variables or a secure source
PORT="{{ (bitwardenFields "item" "bb33de3f-216f-4267-9ab0-ad3300f774cb").Port.value }}"
USERNAME="{{ (bitwarden "item" "bb33de3f-216f-4267-9ab0-ad3300f774cb").login.username }}"
HOST="{{ (index (bitwarden "item" "bb33de3f-216f-4267-9ab0-ad3300f774cb").login.uris 0).uri }}"

# Mount /mnt/raid
create_dir_if_not_exists "/mnt/raid"
mount_sshfs "/mnt/raid" "/mnt/raid" "$PORT" "$USERNAME" "$HOST"

# Mount /mnt/storage
create_dir_if_not_exists "/mnt/storage"
mount_sshfs "/mnt/storage" "/mnt/storage" "$PORT" "$USERNAME" "$HOST"
